(window.webpackJsonp=window.webpackJsonp||[]).push([[66],{524:function(s,n,a){"use strict";a.r(n);var t=a(0),e=Object(t.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[s._v("docker部署和近期编写情况")]),s._v(" "),n("h2",{attrs:{id:"编写"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#编写"}},[s._v("#")]),s._v(" 编写")]),s._v(" "),n("p",[s._v("docker")]),s._v(" "),n("div",{staticClass:"language-dockerfile line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[n("code",[n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" mhart/alpine-node")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#RUN set -xe \\")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    && apk add --no-cache nodejs npm \\")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v("     npm config set registry  https://registry.npmmirror.com "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    npm install -g pm2 "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("\\")]),s._v("\n    rm -rf /tmp/npm* /var/cache/apk/*")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /app")]),s._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Install local required modules")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" package.json package.json")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" yarn install")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . ./")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXPOSE")]),s._v(" 3001")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# create production env")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# HOST=`http://localhost:3000`")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ARG")]),s._v(" DATABASE_URL")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ARG")]),s._v(" JWT_SECRET")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" touch .env")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" echo DATABASE_URL="),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$DATABASE_URL")]),s._v(" >> .env")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token instruction"}},[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" echo JWT_SECRET="),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$JWT_SECRET")]),s._v(" >> .env")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# CMD ["pm2", "/app/src/index.ts"]')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#CMD ["bash","./i.sh"]')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br")])]),n("p",[s._v("运行build\n"),n("code",[s._v("docker build -t p6 .")]),s._v(" "),n("code",[s._v("docker run -itd --name p7 -p 3001:3001 p6")]),s._v(" #保持后台\ndocker run -itd --name p10 -p 3001:3001 --link post:link-post p8\n#链接数据库容器")]),s._v(" "),n("p",[s._v("如果只给-d后台参数的话，必须要跟一个会阻塞的命令如bash，不然容器没有任务又会关掉。或者加-it")]),s._v(" "),n("p",[n("code",[s._v("docker exec -it p7 /bin/sh")]),s._v(" #前台执行命令\n进去之后一组预操作(i.sh)。如需保持前台运行，可以按"),n("code",[s._v("Ctrl + p + q")]),s._v("退出容器。再次进去top显示进程还在后台运行。但是 stop 容器之后再起就不会运行了。")]),s._v(" "),n("p",[s._v("目前.env没有复制也没有写入")]),s._v(" "),n("p",[s._v("需要先--link 到post 然后使用link-post去连接另一个容器的原始端口")]),s._v(" "),n("p",[s._v("手动先修改.env")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('DATABASE_URL="postgresql://postgres:mysecretpassword@link-post:5432/prisma?schema=public"\nJWT_SECRET="aosdifewoefmsalfjjioawefjosaofjaidf"\n\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("测试docker env")]),s._v(" "),n("div",{staticClass:"language-s line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("docker run -itd --name back -p 3001:3001 --link post:link-post prisma  --env-file=.env\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])])])}),[],!1,null,null,null);n.default=e.exports}}]);